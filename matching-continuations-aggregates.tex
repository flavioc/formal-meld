\input{high-level-complete}

\subsection{Low Level System}

\newcommand{\ma}[0]{\m{ma} \;}
\newcommand{\da}[0]{\m{da} \;}
\newcommand{\conta}[0]{\m{cont}_a \;}
\newcommand{\dalla}[0]{\m{dall}_a \;}

We complement the previous system with aggregate derivation. For this, we add the judgements $\ma$, $\da$ and $\conta$ that will match, derive and apply continuations when applying an aggregate.

\subsubsection{Match}

\input{ll-system/match-body}

\subsubsection{Continuation}

\input{ll-system/match-cont}

\subsubsection{Derivation}

We add a new rule for aggregates.

\input{ll-system/derivation}

\[
\infer[\done agg]
{\dz \Gamma; \Delta ; \Xi; \Gamma_1; \Delta_1; \aggregate{Op}{X}{A}{B_1}{B_2}, \Omega \rightarrow \Xi';\Delta';\Gamma'}
{\ma \Gamma; \Delta; \Xi; \Gamma_1; \Delta_1; \cdot; A ; B_1 ; \cdot; \cdot; \aggregate{Op}{X}{A}{B_1}{B_2}; \Omega; \Delta; \cdot \rightarrow \Xi';\Delta';\Gamma'}
\]

\subsubsection{Match Comprehension}

\input{ll-system/match-comprehension}

\subsubsection{Match Comprehension Continuation}

\input{ll-system/comprehension-cont}

\subsubsection{Stack Transformation}

\input{ll-system/strans}

\input{ll-system/comprehension-stack}

\subsubsection{Comprehension Derivation}

The $\dc$ is identical to the previous system, however it has been extended with $\Gamma$, $\Gamma_1$, $C$, $P$ and $\Gamma'$.

\input{ll-system/comprehension-derivation}

\subsubsection{Match Aggregate}

\input{ll-system/match-aggregate}

\subsubsection{Match Aggregate Continuation}

\input{ll-system/aggregate-cont}

\subsubsection{Stack Transform for Aggregates}

\input{ll-system/aggregate-stack}

\subsubsection{Aggregate Derivation}

\input{ll-system/aggregate-derivation}

\subsubsection{Application}

Finally, we add $\Gamma$ and $\Gamma'$ to the main inference rules to complete the system.

\[
\infer[\ao start \; matching]
{\ao \Gamma; \Delta; A \lolli B; R \rightarrow \Xi'; \Delta'; \Gamma'}
{\mo \Gamma; \Delta; \cdot; \cdot; A; B; \cdot; R \rightarrow \Xi'; \Delta'; \Gamma'}
\]

\[
\infer[\doo rule]
{\doo \Gamma; \Delta; R, \Phi \rightarrow \Xi'; \Delta';\Gamma'}
{\ao \Gamma; \Delta; R; (\Phi, \Delta) \rightarrow \Xi';\Delta';\Gamma'}
\]
