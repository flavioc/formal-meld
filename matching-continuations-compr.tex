

\input{high-level}

\subsection{Low Level System}

We extend the previous system with comprehensions.

\subsubsection{Match}


\[
\infer[\mo ok \; first]
{\mo \Delta, p_1, \Delta'' ; \Xi; p, \Omega; H; \cdot; R \rightarrow \Xi'; \Delta'}
{\mo \Delta, \Delta''; \Xi, p_1; \Omega; H; (\Delta, p_1; \Delta''; p; \Omega; \Xi; \cdot); R \rightarrow \Xi'; \Delta'}
\]

\[
\infer[\mo ok \; other]
{\mo \Delta, p_1, \Delta'' ; \Xi; p, \Omega; H; C_1, C; R \rightarrow \Xi'; \Delta'}
{\mo \Delta, \Delta''; \Xi, p_1; \Omega; H; (\Delta, p_1; \Delta''; p ; \Omega; \Xi; q, \Lambda), C_1, C; R \rightarrow \Xi'; \Delta' & C_1 = (\Delta_{old}; \Delta'_{old}; \Xi_{old}; q; \Omega_{old}; \Lambda)}
\]

\[
\infer[\mo fail]
{\mo \Delta; \Xi; p, \Omega; H; C; R \rightarrow \Xi'; \Delta'}
{p \notin \Delta & \cont C ; H; R; \Xi'; \Delta'}
\]

\[
\infer[\mo \otimes]
{\mo \Delta; \Xi; A \otimes B, \Omega ; H ; C; R \rightarrow \Xi'; \Delta'}
{\mo \Delta; \Xi; A, B, \Omega; H; C; R \rightarrow \Xi';\Delta'}
\]

\[
\infer[\mo end]
{\mo \Delta; \Xi; \cdot ; H; C; R \rightarrow \Xi'; \Delta'}
{\done \Delta; \Xi; \cdot ; H; \cdot \rightarrow \Xi'; \Delta'}
\]

\subsubsection{Derive}

\newcommand{\mc}[0]{\m{mc} \; }
\newcommand{\dall}[0]{\m{dall} \; }

\[
\infer[\done p]
{\done \Delta; \Xi; \Delta_1; p, \Omega \rightarrow \Xi'; \Delta'}
{\done \Delta; \Xi; p, \Delta_1; \Omega \rightarrow \Xi'; \Delta'}
\tab
\infer[\done 1]
{\done \Delta; \Xi; \Delta_1; 1, \Omega \rightarrow \Xi';\Delta'}
{\done \Delta; \Xi; \Delta_1; \Omega \rightarrow \Xi'; \Delta'}
\]

\[
\infer[\done \otimes]
{\done \Delta; \Xi; \Delta_1; A \otimes B, \Omega \rightarrow \Xi'; \Delta'}
{\done \Delta; \Xi; \Delta_1; A, B, \Omega \rightarrow \Xi';\Delta'}
\]

\[
\infer[\done end]
{\done \Delta; \Xi; \Delta_1; \cdot \rightarrow \Xi; \Delta_1}
{}
\]

\[
\infer[\done comp]
{\done \Delta ; \Xi; \Delta_1; \comp A \lolli B, \Omega \rightarrow \Xi';\Delta'}
{\mc \Delta; \Xi; \Delta_1; \cdot; A ; B ; \cdot; \comp A \lolli B; \Omega; \Delta \rightarrow \Xi';\Delta'}
\]

\subsubsection{Continuation}

\[
\infer[\cont next \; rule]
{\cont \cdot; H; (\Phi; \Delta); \Xi'; \Delta'}
{\doo \Delta; \Phi \rightarrow \Xi'; \Delta'}
\]


\[
\infer[\cont next]
{\cont (\Delta; p_1, \Delta''; p; \Omega; \Xi; \Lambda), C; H; R; \Xi'; \Delta'}
{\mo \Delta, \Delta''; \Xi, p_1; \Omega; H; (\Delta, p_1; \Delta''; p ; \Omega; \Xi; \Lambda), C; R \rightarrow \Xi'; \Delta'}
\]

\[
\infer[\cont no \; more]
{\cont (\Delta; \cdot; p; \Omega; H; \Xi; \Lambda), C; H; R; \Xi'; \Delta'}
{\cont C; H; R; \Xi'; \Delta'}
\]

\subsubsection{Match Comprehension}

\[
\infer[\mc p \; ok \; first]
{\mc \Delta, p_1, \Delta''; \Xi_N; \Delta_{N1}; \Xi; p, \Omega; \cdot; AB; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta'}
{\mc \Delta, \Delta''; \Xi_N; \Delta_{N1}; \Xi, p_1; \Omega; (\Delta, p_1; \Delta''; \Xi; p; \Omega; \cdot); AB; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta'}
\]

\[
\infer[\mc p \; ok \; other]
{\mc \Delta, p_1, \Delta''; \Xi_N; \Delta_{N1}; \Xi; p, \Omega; C_1, C; AB; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta'}
{\mc \Delta, \Delta''; \Xi_N; \Delta_{N1}; \Xi, p_1; \Omega; (\Delta, p_1; \Delta''; \Xi; p; \Omega; q, \Lambda), C_1, C; AB; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta' & C1 = (\Delta_{old}; \Delta'_{old}; \Xi_{old}; q; \Omega_{old}; \Lambda)}
\]


\[
\infer[\mc p \; fail]
{\mc \Delta; \Xi_N; \Delta_{N1}; \Xi; p, \Omega; C; \comp A \lolli B; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta'}
{\contc \Delta_N; \Xi_N; \Delta_{N1}; C; \comp A \lolli B; \Omega_N \rightarrow \Xi'; \Delta'}
\]

\[
\infer[\mc \otimes]
{\mc \Delta; \Xi_N; \Delta_{N1}; \Xi; X \otimes Y, \Omega; C; \comp A \lolli B; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta'}
{\mc \Delta; \Xi_N; \Delta_{N1}; \Xi; X, Y, \Omega; C; \comp A \lolli B; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta'}
\]

\[
\infer[\mc end]
{\mc \Delta; \Xi_N; \Delta_{N1}; \Xi; \cdot; C; \comp A \lolli B; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta'}
{\dall \Xi_N; \Delta_{N1}; \Xi; C; \comp A \lolli B; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta'}
\]

\[
\infer[\dall end]
{\dall \Xi_N; \Delta_{N1}; \Xi; (\Delta_x; \Delta''; \cdot; p, \Omega; \cdot); \comp A \lolli B; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta'}
{\dc \Xi_N, \Xi; \Delta_{N1}; (\Delta_x - \Xi; \Delta'' - \Xi; \cdot; p; \Omega; \cdot) ; \comp A \lolli B; \Omega_N; (\Delta_N - \Xi) \rightarrow \Xi'; \Delta'}
\]

\[
\infer[\dall more]
{\dall \Xi_N; \Delta_{N1}; \Xi; \_, X, C; \comp A \lolli B; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta'}
{\dall \Xi_N; \Delta_{N1}; \Xi; X, C; \comp A \lolli B; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta'}
\]

\[
\infer[\dc p]
{\dc \Xi; \Delta_1; p, \Omega; C; \comp A \lolli B; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta'}
{\dc \Xi; \Delta_1, p; \Omega; C; \comp A \lolli B; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta'}
\]

\[
\infer[\dc \otimes]
{\dc \Xi; \Delta_1; A \otimes B, \Omega; C; \comp A \lolli B; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta'}
{\dc \Xi; \Delta_1; A, B, \Omega; C; \comp A \lolli B; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta'}
\]

\[
\infer[\dc end]
{\dc \Xi; \Delta_1; \cdot; C; \comp A \lolli B; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta'}
{\contc \Delta_N; \Xi; \Delta_1; C; \comp A \lolli B; \Omega_N \rightarrow \Xi'; \Delta'}
\]

\subsubsection{Match Comprehension Continuation}

\[
\infer[\contc end]
{\contc \Delta_N; \Xi_N; \Delta_{N1}; \cdot; \comp A \lolli B; \Omega \rightarrow \Xi'; \Delta'}
{\done \Delta_N; \Xi_N; \Delta_{N1}; \Omega \rightarrow \Xi'; \Delta'}
\]

\[
\infer[\contc next]
{\contc \Delta_N; \Xi_N; \Delta_{N1}; (\Delta; p_1, \Delta''; \Xi; p; \Omega; \Lambda), C; AB; \Omega_N \rightarrow \Xi'; \Delta'}
{\mc \Delta; \Xi_N; \Delta_{N1}; \Xi; \Omega; (\Delta, p_1; \Delta''; \Xi; p; \Omega; \Lambda), C; AB; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta'}
\]

\[
\infer[\contc next \; empty]
{\contc \Delta_N; \Xi_N; \Delta_{N1}; (\Delta; \cdot; \Xi; p; \Omega; \Lambda), C; AB; \Omega_N \rightarrow \Xi'; \Delta'}
{\contc \Delta_N; \Xi_N; \Delta_{N1}; C; AB; \Omega_N \rightarrow \Xi'; \Delta'}
\]

\subsubsection{Apply}

\[
\infer[\ao start \; matching]
{\ao \Delta; A \lolli B; R \rightarrow \Xi'; \Delta'}
{\mo \Delta; \cdot; A; B; \cdot; R \rightarrow \Xi'; \Delta'}
\]

\[
\infer[\doo rule]
{\doo \Delta; R, \Phi \rightarrow \Xi'; \Delta'}
{\ao \Delta; R; (\Phi; \Delta) \rightarrow \Xi';\Delta'}
\]

\subsection{Definitions}

\subsubsection{Related Comprehension Match}

A match $\mc \Delta_1, \Delta_2; \Xi_N; \Delta_{N1}; \Xi; \Omega; C; \comp A \lolli B; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta'$ is related to a term $A$ and a context $\Delta_{inv}$ if it follows the same conditions described in \ref{sec:related_match}.

\subsection{Theorems}

\subsubsection{Body Match Soundness}

If $\mo \Delta, \Delta''; \cdot; \Omega; H; \cdot; R \rightarrow \Xi'; \Delta'$ then either:\\
\begin{enumerate}
   \item $\cont \cdot; R; \Xi'; \Delta'$ or;
   \item $\mo \Delta; \Delta''; \cdot; H; C'; R \rightarrow \Xi'; \Delta'$ and $\mz \Delta'' \rightarrow \Omega$
\end{enumerate}

\begin{proof}
Proved in Section~\ref{thm:match_soundness_basic}.
\end{proof}

\subsubsection{Comprehension soundness theorem}

\begin{itemize}
   \item Match sub-theorem

If a match $\mc \Delta_1, \Delta_2; \Xi_N; \Delta_{N1}; \Xi; \Omega; C; \comp A \lolli B; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta'$ is related to term $A$ and context $\Delta_{N} = \Delta_1, \Delta_2, \Xi$ then either:

\begin{enumerate}
   \item $\done \Delta_N; \Xi_N; \Delta_{N1}; \Omega_N \rightarrow \Xi'; \Delta'$;
   \item $\mz \Delta_x \rightarrow A$ (where $\Delta_x \subseteq \Delta_N$) and one of the following sub-cases is true:
   
      \begin{enumerate}
         \item $\mc \Delta_1; \Xi_N; \Delta_{N1}, \Xi, \Delta_2; \cdot; C', C; \comp A \lolli B; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta'$ (related) and $\Delta_x = \Delta_2$.
         \item $\exists f = (\Delta_a; \Delta_{b_1}, p_2, \Delta_{b_2}; p; \Omega_1, .., \Omega_k; \Xi_1, ..., \Xi_m; \Lambda_1, ..., \Lambda_m) \in C$ where $C= C', f, C''$ that turns into $f' = (\Delta_a, \Delta_{b_1}, p_2; \Delta_{b_2}; p; \Omega_1, ..., \Omega_k; \Xi_1, ..., \Xi_m; \Lambda_1, ..., \Lambda_m)$ such that:
         \begin{itemize}
            \item $\mc \Delta_c; \Xi_N; \Delta_{N1}; \Xi_1, ..., \Xi_m, p_2, \Xi_c; \cdot; C''', f', C''; \comp A \lolli B; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta'$ (related)
         \end{itemize}
      \end{enumerate}
\end{enumerate}

\item Continuation sub-theorem

If $\contc \Delta_N; \Xi_N; \Delta_{N1}; C; \comp A \lolli B; \Omega_N \rightarrow \Xi'; \Delta'$ and C is well formed in relation to $A$ and $\Delta_1, \Delta_2, \Xi$ then either:

\begin{enumerate}
   \item $\done \Delta_N; \Xi_N; \Delta_{N1}; \Omega_N \rightarrow \Xi'; \Delta'$;
   \item $\exists f = (\Delta_a; \Delta_{b_1}, p_2, \Delta_{b_2}; p; \Omega_1, .., \Omega_k; \Xi_1, ..., \Xi_m; \Lambda_1, ..., \Lambda_m) \in C$ where $C= C', f, C''$ that turns into $f' = (\Delta_a, \Delta_{b_1}, p_2; \Delta_{b_2}; p; \Omega_1, ..., \Omega_k; \Xi_1, ..., \Xi_m; \Lambda_1, ..., \Lambda_m)$ such that:
   \begin{itemize}
      \item $\mc \Delta_c; \Xi_N; \Delta_{N1}; \Xi_1, ..., \Xi_m, p_2, \Xi_c; \cdot; C''', f', C''; \comp A \lolli B; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta'$ (related)
   \end{itemize}
\end{enumerate}

\end{itemize}

\begin{proof}
   By nested induction. In $\mc$ on the size of $\Omega$. In $\contc$, first on the size of $\Delta''$ of the continuation frame and then on the continuation stack $C$. Use the stack constraints and the Match Equivalence Theorem to prove $\mz \Delta_x \rightarrow A$.
   
   \begin{itemize}
      \item $\mc p \; ok \; first$
      
      By induction on $\Omega$.\\
      Stack frame $(\Delta, p_1; \Delta''; \Xi; p; \Omega; \cdot)$ is related. \\
      
      \item $\mc p \; ok \; other$
      
      By induction on $\Omega$.\\
      First we prove that the inverted match is related. We know that
      $q \in \Xi$ due to our assumption, so that proves $\mz q \rightarrow q$. Second, we prove that the new stack frame $(\Delta, p_1; \Delta''; \Xi; p; \Omega; q, \Lambda)$ is related and then apply induction.
      
      \item $\mc p \; fail$
      
      By mutual induction on $\contc$.
      
      \item $\mc \otimes$
      
      By induction on $\Omega$. \\
      
      \item $\mc end$
      
      The stack must have some frames, thus $\feq{p, \Lambda_c}{A}$ ($p$ and $\Lambda_c$ both arguments of the last frame). We also know that $p \in \Xi$ due to our assumption and that $\mz \Xi_c, p \rightarrow \Delta \otimes p$ is true. Therefore $\Xi = \Xi_c, p$ and thus $\mz \Xi \rightarrow A$.
      
      \item $\contc end$
      
      Select case 1 by inverting the assumption.
      
      \item $\contc next$
      
      By induction on $\Delta''$.\\
      
      \item $\contc next \; empty$
      
      By induction on the size of $C$.
      
   \end{itemize}
\end{proof}

\subsubsection{Comprehension soundness lemma}

If $\mc \Delta, \Xi; \Xi_N; \Delta_{N1}; \cdot; A; \cdot; \comp A \lolli B; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta'$ where $\Delta, \Xi = \Delta_N$ and the match is related to both $\Delta_N$ and $A$ then either:\\
\begin{enumerate}
   \item $\done \Delta_N; \Xi_N; \Delta_{N1}; \Omega_N \rightarrow \Xi'; \Delta'$ or
   \item $\mc \Delta; \Xi_N; \Delta_{N1}; \Xi; \cdot; C'; \comp A \lolli B; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta'$ and
      \begin{enumerate}
         \item $\mz \Delta_1 \rightarrow A$
         \item $C'$ is well formed in relation to $A$ and $\Delta, \Xi$.
      \end{enumerate}
\end{enumerate}

\begin{proof}
Direct application of the previous theorem.
\end{proof}

\subsubsection{Dall transformation theorem}

If $\dall \Xi_N; \Delta_{N1}; \Xi; C, (\Delta_a; \Delta_b; \cdot; \Omega; \cdot); \comp A \lolli B; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta'$ then 
$\dc \Xi_N, \Xi; \Delta_{N1}; B; (\Delta_a - \Xi; \Delta_b - \Xi; \cdot; \Omega; \cdot); \comp A \lolli B; \Omega_N; (\Delta_N - \Xi) \rightarrow \Xi'; \Delta'$.

\begin{proof}
   By induction on the size of the continuation stack $C$.
   
   \begin{itemize}
      \item $C = \_, X, C'$
      
      $\dall \Xi_N; \Delta_{N1}; \Xi; \_, X, C'; \comp A \lolli B; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta'$ \hfill (1) assumption \\
      $\dall \Xi_N; \Delta_{N1}; \Xi; X, C'; \comp A \lolli B; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta'$ \hfill (2) inversion of (1) \\
      $\dc \Xi_N, \Xi; \Delta_{N1}; B; (\Delta_a - \Xi; \Delta_b - \Xi; \cdot; \Omega; \cdot); \comp A \lolli B; \Omega_N; (\Delta_N - \Xi) \rightarrow \Xi'; \Delta'$ \hfill (3) i.h. on (2) \\
      
      \item $C = (\Delta_a - \Xi; \Delta_b - \Xi; \cdot; \Omega; B)$
      
      $\dall \Xi_N; \Delta_{N1}; \Xi; (\Delta_a; \Delta_b; \cdot; \Omega; \cdot); \comp A \lolli B; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta'$ \hfill (1) assumption \\
      $\dc \Xi_N, \Xi; \Delta_{N1}; B; (\Delta_a - \Xi; \Delta_b - \Xi; \cdot; \Omega; B); \comp A \lolli B; \Omega_N; (\Delta_N - \Xi) \rightarrow \Xi'; \Delta'$ \hfill (2) inversion of (1) \\
   \end{itemize}
\end{proof}

\subsubsection{Successful comprehension match gives derivation}

If $\mc \Delta; \Xi_N; \Delta_{N1}; \Xi; \cdot; B; C, (\Delta_a; \Delta_b; \cdot; p; \Omega; \cdot); \comp A \lolli B; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta'$ then
$\dc \Xi_N, \Xi; \Delta_{N1}; B; (\Delta_a - \Xi; \Delta_b - \Xi; \cdot; p; \Omega; \cdot); \comp A \lolli B; \Omega_N; (\Delta_N - \Xi) \rightarrow \Xi'; \Delta'$.

\begin{proof}
   Invert the assumption and then apply dall transformation theorem.
\end{proof}

\subsubsection{Continuation derivation theorem}

If $\dc \Xi_N; \Delta_{N1}; \Omega_1, ..., \Omega_n; C; \comp A \lolli B; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta'$ then:
\begin{enumerate}
   \item $\dc \Xi_N; \Delta_{N1}, \Delta_1, ..., \Delta_n; \cdot; C; \comp A \lolli B; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta'$ and
   \item If $\dz \Delta; \Xi_N; \Delta_{N1}, \Delta_1, ..., \Delta_n; \Omega \rightarrow \Xi'; \Delta'$ then $\dz \Delta; \Xi_N; \Delta_{N1}; \Omega_1, ..., \Omega_n, \Omega \rightarrow \Xi'; \Delta'$
\end{enumerate}

\begin{proof}
   By induction on the size of $\Omega_1, ..., \Omega_n$.
   
   \begin{itemize}
      \item $p, \Omega$
      
      $\dc \Xi_N; \Delta_{N1}; p, \Omega_2, ..., \Omega_n; C; \comp A \lolli B; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta'$ \hfill (1) assumption \\
      $\dc \Xi_N; \Delta_{N1}, p; \Omega_2, ..., \Omega_n; C; \comp A \lolli B; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta'$ \hfill (2) inversion of (1) \\
      $\dc \Xi_N; \Delta_{N1}, p, \Delta_2, ..., \Delta_n; \cdot; C; \comp A \lolli B; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta'$ \hfill (3) i.h. on (2) \\
      if $\dz \Delta; \Xi_N; \Delta_{N1}, p, \Delta_2, ..., \Delta_n; \Omega \rightarrow \Xi'; \Delta'$ then $\dz \Delta; \Xi_N; \Delta_{N1}; p, \Omega_2, ..., \Omega_n, \Omega \rightarrow \Xi'; \Delta'$ \hfill (4) i.h. on (2) \\
      $\dz \Delta; \Xi_N; \Delta_{N1}, p, \Delta_2, ..., \Delta_n; \Omega \rightarrow \Xi'; \Delta'$ \hfill (5) from (4) \\
      $\dz \Delta; \Xi_N; \Delta_{N1}; p, \Omega_2, ..., \Omega_n, \Omega \rightarrow \Xi'; \Delta'$ \hfill (6) using (5) on (4) \\
      
      \item $1, \Omega$
      
      By induction.
      
      \item $A \otimes B, \Omega$
      
      $\dc \Xi_N; \Delta_{N1}; A \otimes B, \Omega_2, ..., \Omega_n; C; \comp A \lolli B; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta'$ \hfill (1) assumption \\
      $\dc \Xi_N; \Delta_{N1}; A, B, \Omega_2, ..., \Omega_n; C; \comp A \lolli B; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta'$ \hfill (2) inversion of (1) \\
      Solve by induction on (2) \\
   \end{itemize}
\end{proof}

\subsubsection{Continuation derivation lemma}

If $\dc \Xi_N; \Delta_{N1}; \Omega_x; C; \comp A \lolli B; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta'$ then:
\begin{enumerate}
   \item $\dc \Xi_N; \Delta_{N1}, \Delta_x; \cdot; C; \comp A \lolli B; \Omega_N; \Delta_N \rightarrow \Xi'; \Delta'$ and
   \item If $\dz \Delta; \Xi_N; \Delta_{N1}, \Delta_x; \Omega \rightarrow \Xi'; \Delta'$ then $\dz \Delta; \Xi_N; \Delta_{N1}; \Omega_x, \Omega \rightarrow \Xi'; \Delta'$
\end{enumerate}

\begin{proof}
   By direct application of the continuation derivation theorem.
\end{proof}

\subsubsection{Comprehension Theorem}

If $\mc \Delta_a, \Delta'_b; \Xi_N; \Delta_{N1}; p_1; \Omega; (\Delta_a, p_1; \Delta'_b; \cdot; p; \Omega; \cdot); \comp A \lolli B; \Omega_N; \Delta, \Xi_1, ..., \Xi_n \rightarrow \Xi'; \Delta'$ and $\Delta_a, \Delta_b = \Delta, \Xi_1, ..., \Xi_n$ and $\feq{p, \Omega}{A}$ then $\exists n \geq 0$ such that:
\begin{enumerate}
   \item $\done \Delta; \Xi_N, \Xi_1, ..., \Xi_n; \Delta_{N1}, \Delta_1, ..., \Delta_n; \Omega_N \rightarrow \Xi'; \Delta'$
   \item $\mz \Xi_1 \rightarrow A$ ... $\mz \Xi_n \rightarrow A$
   \item $n$ implications from $1 ... i ... n$ such that: $\forall \Omega_x, \Delta_x.$ if $\dz \Delta_x; \Xi_N, \Xi_1, ..., \Xi_i; \Delta_{N1}, \Delta_1, ..., \Delta_i; \Omega_x \rightarrow \Xi'; \Delta'$ then $\dz \Delta_x; \Xi_N, \Xi_1, ..., \Xi_i; \Delta_{N1}, \Delta_1, ..., \Delta_{i-1}; B, \Omega_x \rightarrow \Xi'; \Delta'$.
\end{enumerate}

\begin{proof}
   By induction on the size of $\Delta'_b$.\\

   $\Delta_b = p_1, \Delta'_b$ \hfill (1) from assumption \\
   $\Delta_a, p_1, \Delta'_b = \Delta, p, \Xi'_1, ..., \Xi_n$ \hfill (2) from assumption \\
   By applying the comprehension soundness theorem on the assumption:\\
      
   \begin{itemize}
      \item Failure:
         
      $\done \Delta, \Xi_1, ..., \Xi_n; \Xi_N; \Delta_{N1}; \Omega_N \rightarrow \Xi'; \Delta'$ \hfill (3) assumption (so $n = 0$)\\
         
      \item Success $\mz \Delta_x \rightarrow A$:
      
      \begin{enumerate}
         
         \item Without backtracking:
         
         $\mc \Delta, \Xi_2, ..., \Xi_n; \Xi_N; \Delta_{N1}; p, \Xi'_1; \cdot; C', (\Delta_a, p_1; \Delta'_b; \cdot; p; \Omega; \cdot); \comp A \lolli B; \Omega_N; \Delta, \Xi_1, ..., \Xi_n \rightarrow \Xi'; \Delta'$ \hfill (3) assumption \\
         $\mz p_1, \Xi'_1 \rightarrow A$ \hfill (4) from theorem\\
         $\dc \Xi_N, p, \Xi'_1; \Delta_{N1}; B; (\Delta_a, p_1 - (p_1, \Xi'_1); \Delta'_b - (p_1, \Xi'_1); \cdot; p; \Omega; \cdot); \comp A \lolli B; \Omega_N; (\Delta, \Xi_1, ..., \Xi_n) - \Xi_1 \rightarrow \Xi'; \Delta'$ \hfill (5) apply successful comprehension matches gives derivation lemma to (3) \\
         $\dc \Xi_N, p, \Xi'_1; \Delta_{N1}; B; (\Delta_a - \Xi'_1; \Delta'_b - \Xi'_1; \cdot; p; \Omega; \cdot); \comp A \lolli B; \Omega_N; \Delta, \Xi_2, ..., \Xi_n \rightarrow \Xi'; \Delta'$ \hfill (6) simplification of (5) \\
         $\dc \Xi_N, p, \Xi'_1; \Delta_{N1}, \Delta_1; \cdot; (\Delta_a - \Xi'_1; \Delta'_b - \Xi'_1; \cdot; p; \Omega; \cdot); \comp A \lolli B; \Omega_N; \Delta, \Xi_2, ..., \Xi_n \rightarrow \Xi'; \Delta'$ \hfill (7) from continuation derivation lemma on (6)\\
         if $\forall \Omega_x, \Delta_x. \dz \Delta_x; \Xi_N, p, \Xi'_1; \Delta_{N1}, \Delta_1; \Omega_x \rightarrow \Xi'; \Delta'$ then $\dz \Delta_x; \Xi_N, p, \Xi'_1; \Delta_{N1}; B, \Omega_x \rightarrow \Xi'; \Delta'$ \hfill (8) using the same lemma \\
         $\contc \Delta, \Xi_2, ..., \Xi_n; \Xi_N, p, \Xi'_1; \Delta_{N1}, \Delta_1; (\Delta_a - \Xi'_1; \Delta'_b - \Xi'_1; \cdot; p; \Omega; \cdot); \comp A \lolli B; \Omega_N \rightarrow \Xi'; \Delta'$ \hfill (9) inversion of (7) \\   
      
         When inverting (9), we have two subcases:
      
         $\Delta_a - \Xi'_1 = \Delta''_a$ \hfill (10) \\
         $\Delta'_b - \Xi'_1 = \Delta''_b$ \hfill (11) \\
         $\Delta''_a, \Delta''_b = \Delta, \Xi_2, ..., \Xi_n$ \hfill (12) \\
      
         \begin{itemize}
            \item End ($n = 1$):
         
            $\contc \Delta, \Xi_2, ..., \Xi_n; \Xi_N, \Xi_1; \Delta_{N1}, \Delta_1; \cdot; \comp A \lolli B; \Omega_N \rightarrow \Xi'; \Delta'$ \hfill (13) \hfill inversion of (9) \\
            $\done \Delta, \Xi_2, ..., \Xi_n; \Xi_N, \Xi_1; \Delta_{N1}, \Delta_1; \Omega_N \rightarrow \Xi'; \Delta'$ \hfill (14) inverting (13), which is what we want \\
         
            \item Next ($n = n' + 1$):
         
            $\Delta'''_b = \Delta''_b, p_2$ \hfill (13) from inversion \\
            $\mc \Delta''_a, \Delta'''_b; \Xi_N, \Xi_1; \Delta_{N1}, \Delta_1; \cdot; \Omega; (\Delta''_a, p_2; \Delta'''_b; \cdot; p; \Omega; \cdot); \comp A \lolli B; \Omega_N; \Delta, \Xi_2, ..., \Xi_n \rightarrow \Xi'; \Delta'$ \hfill (14) inversion of (9) \\
            Apply induction hypotheses to (14) to get results from $n'$.\\ 
         \end{itemize}
      
         \item With backtracking:
   
         $f = (\Delta_a, p_1; \Delta'_b; \cdot; p; \Omega; \cdot)$ \hfill (3) from theorem \\
         turns into $f' = (\Delta_a, p_1, \Delta'''_b, p_2; \Delta''_b; \cdot; p; \Omega; \cdot)$ \hfill (4) from theorem (3) \\
         $\mc \Delta, \Xi_2, ..., \Xi_n; \Xi_N; \Delta_{N1}; p_2, \Xi'_1; \cdot; C', f'; \comp A \lolli B; \Omega_N; \Delta, \Xi_1, ..., \Xi_n \rightarrow \Xi'; \Delta'$ \hfill (5) from theorem (3) \\
         $\mz p_2, \Xi'_1 \rightarrow p \otimes \Omega$ \hfill (6) from theorem (3) where $p_2, \Xi'_1 = \Delta_x$ \\
         $\feq{p, \Omega}{A}$ \hfill (7) from assumptions \\
         $\mz p_2, \Xi'_1 \rightarrow A$ \hfill (8) using match equivalence theorem \\
   
         Use the same approach as the last sub-case, but using $p_2$ instead of $p_1$ and using the fact that $\Delta_b$ was already reduced because we had to backtrack.
      \end{enumerate}
   \end{itemize}
   
   
\end{proof}

\subsubsection{Comprehension Lemma}

If $\mc \Delta, \Xi_1, ..., \Xi_n; \Xi_N; \Delta_{N1}; \cdot; A; \cdot; \comp A \lolli B; \Omega_N; \Delta, \Xi_1, ..., \Xi_n \rightarrow \Xi'; \Delta'$ then we can apply the comprehension $n >= 0$ times:
\begin{enumerate}
   \item $\done \Delta; \Xi_N, \Xi_1, ..., \Xi_n; \Delta_{N1}, \Delta_1, .., \Delta_n; \Omega_N \rightarrow \Xi'; \Delta'$ for $\exists n \geq 0$
   \item $\mz \Xi_1 \rightarrow A$ ... $\mz \Xi_n \rightarrow A$.
   \item $n$ implications from $1 ... i ... n$ such that: $\forall \Omega_x, \Delta_x.$ if $\dz \Delta_x; \Xi_N, \Xi_1, ..., \Xi_i; \Delta_{N1}, \Delta_1, ..., \Delta_i; \Omega_x \rightarrow \Xi'; \Delta'$ then $\dz \Delta_x; \Xi_N, \Xi_1, ..., \Xi_i; \Delta_{N1}, \Delta_1, ..., \Delta_{i-1}; B, \Omega_x \rightarrow \Xi'; \Delta'$.
\end{enumerate}

\begin{proof}
   Applying the comprehension soundness lemma, we get two cases:
   
   \begin{itemize}
      \item Failure:
      
      $\done \Delta, \Xi_1, ..., \Xi_n; \Xi_N; \Delta_{N1}; \Omega_N \rightarrow \Xi'; \Delta'$ \hfill no comprehension application was possible.
      
      \item Success:
      
      $\mc \Delta, \Xi_2, ..., \Xi_n; \Xi_N; \Delta_{N1}; \Xi_1; \cdot; C'; \comp A \lolli B; \Omega_N; \Delta, \Xi_1, ..., \Xi_n \rightarrow \Xi'; \Delta'$ \hfill (1) result from theorem \\
      $\mz \Xi_1 \rightarrow A$ \hfill (2) from theorem \\
      $\mc$ in (1) is related \hfill (3) from theorem \\
      $C$ is well formed in relation to $A$ and $\Delta, \Xi_1, ..., \Xi_n$ \hfill (4) from theorem \\
      
      $\dc \Xi_N, \Xi_1; \Delta_{N1}; B; (\Delta_a - \Xi_1; \Delta_b - \Xi_1; \cdot; p; \Omega; \cdot); \comp A \lolli B; \Omega_N; (\Delta, \Xi_1, ..., \Xi_n - \Xi_1) \rightarrow \Xi'; \Delta'$ \hfill (5) applying successful comprehension match gives derivation \\
      $\dc \Xi_N, \Xi_1; \Delta_{N1}; B; (\Delta_a - \Xi_1; \Delta_b - \Xi_1; \cdot; p; \Omega; \cdot); \comp A \lolli B; \Omega_N; \Delta, \Xi_2, ..., \Xi_n \rightarrow \Xi'; \Delta'$ \hfill (6) simplifying (5) \\
      $\Delta_a, \Delta_b = \Delta, \Xi_1, ..., \Xi_n$ \hfill (7) from (4) \\
      $(\Delta_a - \Xi_1), (\Delta_b - \Xi_1) = (\Delta_a, \Delta_b) - \Xi_1 = \Delta_, \Xi_2, .., \Xi_n$ and $\Delta'_a = \Delta_a - \Xi_1$ and $\Delta'_b = \Delta_b - \Xi_1$ \hfill (8) from (7) and (6) \\
      $\feq{p, \Omega}{A}$ \hfill (9) from (4) and (6) \\
      $\dc \Xi_N, \Xi_1; \Delta_{N1}, \Delta_1; (\Delta'_a; \Delta'_b; \cdot; p; \Omega; \cdot); \comp A \lolli B; \Omega_N; \Delta, \Xi_2, ..., \Xi_n \rightarrow \Xi'; \Delta'$ \hfill (10) using continuation derivation lemma \\
      if $\forall \Omega_x, \Delta_x. \dz \Delta_x; \Xi_N, \Xi_1; \Delta_{N1}, \Delta_1; \Omega_x \rightarrow \Xi'; \Delta'$ then $\dz \Delta_x; \Xi_N, \Xi_1; \Delta_{N1}; B, \Omega_x \rightarrow \Xi'; \Delta'$ \hfill (11) using the same lemma \\ 
      $\contc \Delta, \Xi_2, ..., \Xi_n; \Xi_N, \Xi_1; \Delta_{N1}, \Delta_1; (\Delta'_a; \Delta'_b; \cdot; p; \Omega; \cdot); \comp A \lolli B; \Omega_N \rightarrow \Xi'; \Delta'$ \hfill (12) inversion of (10) \\
      Apply continuation theorem to the inversion of (12) to get either $0$ applications of the comprehension or the remaining $n-1$.
   \end{itemize}
\end{proof}

\subsubsection{Body Derive Soundness}

If $\done \Delta; \Xi; \Delta_1; \Omega \rightarrow \Xi'; \Delta$ then $\dz \Delta; \Xi; \Delta_1; \Omega \rightarrow \Xi'; \Delta'$.

\begin{proof}
   By induction on $\Omega$.
   
   \begin{itemize}
      \item $p, \Omega$
      
      By induction.
      
      \item $1, \Omega$
      
      By induction.
      
      \item $A \otimes B, \Omega$
      
      By induction.
      
      \item $\cdot$
      
      Use axiom.
      
      \item $\comp A \lolli B, \Omega$
      
      By using the comprehension lemma, we get $n$ applications of the comprehension.\\
      $\Delta = \Delta, \Xi_1, ..., \Xi_n$ \hfill (1)\\
      $\done \Delta; \Xi, \Xi_1, ..., \Xi_n; \Delta_1, \Delta_{c_1}, ..., \Delta_{c_n}; \Omega \rightarrow \Xi'; \Delta'$ \hfill (2) from lemma \\
      $\dz \Delta; \Xi, \Xi_1, ..., \Xi_n; \Delta_1, \Delta_{c_1}, ..., \Delta_{c_n}; \Omega \rightarrow \Xi'; \Delta'$ \hfill (3) i.h. on (2) \\
      $\dz \Delta; \Xi, \Xi_1, ..., \Xi_n; \Delta_1, \Delta_{c_1}, ..., \Delta_{c_n}; 1, \Omega \rightarrow \Xi'; \Delta'$ \hfill (4) apply $\dz 1$ on (3) \\
      $\dz \Delta; \Xi, \Xi_1, ..., \Xi_n; \Delta_1, \Delta_{c_1}, ..., \Delta_{c_n}; 1 \with (A \lolli B \otimes \comp A \lolli B), \Omega \rightarrow \Xi'; \Delta'$ \hfill (5) apply $\dz \with L$ on (4) \\
      $\dz \Delta; \Xi, \Xi_1, ..., \Xi_n; \Delta_1, \Delta_{c_1}, ..., \Delta_{c_n}; \comp A \lolli B, \Omega \rightarrow \Xi'; \Delta'$ \hfill (6) apply $\dz comp$ on (5) \\
      Using the $n^{th}$ implication of the comprehension theorem:\\
      $\dz \Delta; \Xi, \Xi_1, ..., \Xi_n; \Delta_1, \Delta_{c_1}, ..., \Delta_{c_{n-1}}; B, \comp A \lolli B, \Omega \rightarrow \Xi'; \Delta'$ \hfill (7) \\
      Using the $\mz \Xi_n \rightarrow A$ result: \\
      $\dz \Delta, \Xi_n; \Xi_1, ..., \Xi_{n-1}; \Delta_1, \Delta_{c_1}, ..., \Delta_{c_{n-1}}; A \lolli B, \comp A \lolli B, \Omega \rightarrow \Xi'; \Delta'$ \hfill (8) using $\mz$ on (7) \\
      $\dz \Delta, \Xi_n; \Xi_1, ..., \Xi_{n-1}; \Delta_1, \Delta_{c_1}, ..., \Delta_{c_{n-1}}; A \lolli B \otimes \comp A \lolli B, \Omega \rightarrow \Xi'; \Delta'$ \hfill (9) applying rule $\dz \otimes$ on (8) \\
      $\dz \Delta, \Xi_n; \Xi_1, ..., \Xi_{n-1}; \Delta_1, \Delta_{c_1}, ..., \Delta_{c_{n-1}}; 1 \with (A \lolli B \otimes \comp A \lolli B), \Omega \rightarrow \Xi'; \Delta'$ \hfill (10) applying rule $\dz \with R$ on (9) \\
      $\dz \Delta, \Xi_n; \Xi_1, ..., \Xi_{n-1}; \Delta_1, \Delta_{c_1}, ..., \Delta_{c_{n-1}}; \comp A \lolli B, \Omega \rightarrow \Xi'; \Delta'$ \hfill (11) applying rule $\dz comp$ on (10) \\
      By applying the other $n-1$ comprehensions we will get: \\
      $\dz \Delta, \Xi_1, ..., \Xi_n; \Delta_1; \comp A \lolli B, \Omega \rightarrow \Xi'; \Delta'$ \hfill (12)
   \end{itemize}
\end{proof}